### Prerequisites:-(Kubernetes, Helm and Git repo)
* **Install Helm and Tiller**
* **Create a service account and a cluster role binding for Tiller**
* **Deploy Tiller in kube-system namespace**
* **Create the config repo like presented below**

```

├── charts
│   └── node
│       ├── Chart.yaml
│       ├── .helmignore
│       ├── templates
│       └── values.yaml
├── namespaces
│   ├── bank1-ns.yaml
│   └── notary-ns.yaml
└── releases
    ├── dev
    │   └── Bank1
    │        └── bank1-database.yaml
    │            
    └── stg
        └── Bank1
            └── bank1-database.yaml

```
* **NOTE**: Helm chart for corda system located inside the *charts* directory, `HelmRelease` definition are located in *releases/dev* which will create resourse inside namespace generated by the yaml file located in *namespaces* directory, for getting environment specific helmrelease for particular cluster provide the 'git.path' while installing flux.


### STEP-1: To install Flux with a private git host. 
 
* Get the ssh.known_hosts keys by running the following command:

```bash
    ssh-keyscan innersource.accenture.com
```

* Copy generated ssh.known_hosts keys into a temporary file /data/corda/flux/flux_known_hosts

```bash
    mkdir -p /data/corda/flux
    cd /data/corda/flux
    vi flux_known_hosts
    chmod -R 777 flux_known_hosts
```

### STEP-2: Add the Weave Flux chart repo.

```bash
    helm repo add weaveworks https://weaveworks.github.io/flux
```

### STEP-3: Install Weave Flux and its Helm Operator.

* **NOTE**: The configuration section in given URL lists all the parameters that can be configured during installation:- https://github.com/weaveworks/flux/tree/master/chart/flux
  
```bash  
    helm install --name flux \
    --set rbac.create=true \
    --set helmOperator.create=true \
    --set git.url=ssh://git@innersource.accenture.com/dlta/dlt-corda-gitops-all.git \
    --set git.branch=master \
    --set git.path="releases/dev" \
    --set-file ssh.known_hosts=/data/corda/flux/flux_known_hosts \
    --namespace default \
    weaveworks/flux  
```

### STEP-4: Synchronisation of cluster state with config repo.
* **NOTE**:
   * In order to sync cluster state with GitHub copy the public key and create a deploy key with write access on GitHub repository. Go to Settings > Deploy keys click on Add deploy key, check Allow write access, paste the Flux public key and click Add key.
   * The Flux Helm operator provides an extension to Weave Flux that automates Helm Chart releases for it. 
   * A Chart release is described through a Kubernetes custom resource named HelmRelease.
   * The Flux daemon synchronizes these resources from git to the cluster,and the Flux Helm operator makes sure Helm charts are released as specified in the resources.


* Find the SSH public key by running the following command:

```bash
   kubectl -n default logs deployment/flux | grep identity.pub | cut -d '"' -f2
```

  
### To temporarily make Flux ignore a deployment.
* **NOTE**: Add following annotation in the manifest files to make Flux ignore a deployment, daemonset, cronjob, statefulset, helmrelease and fluxhelmrelease.

    flux.weave.works/ignore: true  

### Uninstalling the flux deployment.
* **NOTE**: On HelmRelease CRD deletion, Kubernetes will remove all HelmRelease CRs triggering a Helm purge for each release created by Flux. To avoid this manually delete the Flux Helm Operator with:

```bash
    helm del flux --purge
```

* HelmRelease CRD deletion:

```bash
    kubectl delete crd fluxhelmreleases.helm.integrations.flux.weave.works helmreleases.flux.weave.works
```
